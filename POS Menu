import 'package:flutter/material.dart';
import 'package:http/http.dart' as http;
import 'dart:convert';
import 'package:pdf/pdf.dart';
import 'package:pdf/widgets.dart' as pw;
import 'package:printing/printing.dart';
import 'package:shared_preferences/shared_preferences.dart';
import 'package:flutter/services.dart'; // Ù…ÙƒØªØ¨Ø© Ø§Ù„ØªØ­ÙƒÙ… ÙÙŠ Ø®Ø¯Ù…Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù…

void main() => runApp(
  MaterialApp(
    title: 'ØªÙƒÙ†ÙˆÙ„ÙˆØ¬ÙŠØ§ Ø§Ù„Ø¨Ø±Ù…Ø¬ÙŠØ§Øª Ø§Ù„Ø°ÙƒÙŠØ©',
    home: SplashScreen(), // Ø§Ù„Ø´Ø§Ø´Ø© Ø§Ù„Ù…ØªØ­Ø±ÙƒØ© Ù‡ÙŠ Ù†Ù‚Ø·Ø© Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø¢Ù†
    debugShowCheckedModeBanner: false,
    theme: ThemeData(primarySwatch: Colors.blueGrey, useMaterial3: true),
  ),
);
// --- Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„Ø§Øª (Data Models) ---

class TableModel {
  final int id;
  final String status;
  TableModel({required this.id, required this.status});
  factory TableModel.fromJson(Map<String, dynamic> json) =>
      TableModel(id: json['id'], status: json['status'].toString());
}

class CategoryModel {
  final String name;
  CategoryModel({required this.name});
  factory CategoryModel.fromJson(Map<String, dynamic> json) =>
      CategoryModel(name: json['name'] ?? json['CategoryName'] ?? "");
}

class ProductModel {
  final int id;
  final String name;
  final double price;
  ProductModel({required this.id, required this.name, required this.price});
  factory ProductModel.fromJson(Map<String, dynamic> json) => ProductModel(
    id: json['id'] ?? 0,
    name: json['name'] ?? "",
    price: (json['price'] ?? json['Price'] ?? 0.0).toDouble(),
  );
}

// --- Ø´Ø§Ø´Ø© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ---

class SettingsScreen extends StatefulWidget {
  @override
  _SettingsScreenState createState() => _SettingsScreenState();
}

class _SettingsScreenState extends State<SettingsScreen> {
  final TextEditingController _ipController = TextEditingController();

  @override
  void initState() {
    super.initState();
    _loadSavedIp();
  }

  _loadSavedIp() async {
    SharedPreferences prefs = await SharedPreferences.getInstance();
    setState(() {
      _ipController.text =
          prefs.getString('server_ip') ?? "192.168.100.41:35398";
    });
  }

  _saveIp() async {
    SharedPreferences prefs = await SharedPreferences.getInstance();
    await prefs.setString('server_ip', _ipController.text);
    ScaffoldMessenger.of(context).showSnackBar(
      const SnackBar(content: Text("ØªÙ… Ø­ÙØ¸ Ø¹Ù†ÙˆØ§Ù† IP Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ø¨Ù†Ø¬Ø§Ø­")),
    );
    Navigator.pop(context, true);
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(title: const Text("Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø³ÙŠØ±ÙØ±")),
      body: Padding(
        padding: const EdgeInsets.all(20.0),
        child: Column(
          children: [
            const Icon(Icons.settings_remote, size: 80, color: Colors.blueGrey),
            const SizedBox(height: 20),
            TextField(
              controller: _ipController,
              decoration: const InputDecoration(
                labelText: "Ø¹Ù†ÙˆØ§Ù† IP Ø§Ù„Ø³ÙŠØ±ÙØ± (Ù…Ø¹ Ø§Ù„Ø¨ÙˆØ±Øª)",
                hintText: "Ù…Ø«Ø§Ù„: 192.168.1.10:35398",
                border: OutlineInputBorder(),
              ),
              keyboardType: TextInputType.url,
            ),
            const SizedBox(height: 20),
            ElevatedButton.icon(
              onPressed: _saveIp,
              icon: const Icon(Icons.save),
              label: const Text("Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª"),
              style: ElevatedButton.styleFrom(
                minimumSize: const Size(double.infinity, 50),
              ),
            ),
          ],
        ),
      ),
    );
  }
}

// --- Ø§Ù„Ø´Ø§Ø´Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰: Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ø§ÙˆÙ„Ø§Øª ---

class TableManagementScreen extends StatefulWidget {
  @override
  _TableManagementScreenState createState() => _TableManagementScreenState();
}

class _TableManagementScreenState extends State<TableManagementScreen> {
  List<TableModel> tables = [];
  bool isLoading = true;
  String baseIp = "192.168.100.41:35398";

  @override
  void initState() {
    super.initState();
    _initIpAndFetch();
  }

  Future<void> _initIpAndFetch() async {
    SharedPreferences prefs = await SharedPreferences.getInstance();
    setState(() {
      baseIp = prefs.getString('server_ip') ?? "192.168.100.41:35398";
    });
    fetchTables();
  }

  Future<void> fetchTables() async {
    setState(() => isLoading = true);
    try {
      final response = await http.get(
        Uri.parse("http://$baseIp/api/tables/list"),
      );
      if (response.statusCode == 200) {
        List<dynamic> data = json.decode(response.body);
        setState(() {
          tables = data.map((item) => TableModel.fromJson(item)).toList();
          // ØªØ±ØªÙŠØ¨ Ø§Ù„Ø·Ø§ÙˆÙ„Ø§Øª Ù…Ù† 1 Ø¥Ù„Ù‰ ..
          tables.sort((a, b) => a.id.compareTo(b.id));
          isLoading = false;
        });
      }
    } catch (e) {
      setState(() => isLoading = false);
      debugPrint("Connection Error: $e");
    }
  }

  Future<List<dynamic>> getTableOrders(int tableId) async {
    try {
      final response = await http.get(
        Uri.parse("http://$baseIp/api/orders/kitchen"),
      );
      if (response.statusCode == 200) {
        List<dynamic> all = json.decode(response.body);
        return all
            .where((o) => (o['tableId'] == tableId || o['TableID'] == tableId))
            .toList();
      }
    } catch (e) {
      debugPrint(e.toString());
    }
    return [];
  }

  void _viewOrderDialog(int tableId) async {
    // 1. Ø¥Ø¸Ù‡Ø§Ø± Ù…Ø¤Ø´Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„
    showDialog(
      context: context,
      barrierDismissible: false,
      builder: (c) => const Center(child: CircularProgressIndicator()),
    );

    // 2. Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±
    var items = await getTableOrders(tableId);
    if (!mounted) return;
    Navigator.pop(context); // Ø¥ØºÙ„Ø§Ù‚ Ù…Ø¤Ø´Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„

    // 3. Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ§Øª ÙˆÙ…Ù„Ø§Ø­Ø¸Ø© Ø§Ù„Ø·Ø§ÙˆÙ„Ø©
    double totalAmount = 0.0;
    int totalQty = 0;
    String tableNote = "";

    for (var item in items) {
      double p = double.tryParse(item['Price']?.toString() ?? "0") ?? 0.0;
      int q =
          int.tryParse(
            item['Quantity']?.toString() ?? item['quantity']?.toString() ?? "0",
          ) ??
          0;
      totalAmount += (p * q);
      totalQty += q;

      if (tableNote.isEmpty && item['tableNote'] != null) {
        tableNote = item['tableNote'].toString();
      }
    }

    // 4. Ø¹Ø±Ø¶ Ø§Ù„Ø¯Ø§ÙŠÙ„ÙˆØ¬
    showDialog(
      context: context,
      builder: (context) => AlertDialog(
        title: Text("ØªÙØ§ØµÙŠÙ„ Ø·Ù„Ø¨ Ø·Ø§ÙˆÙ„Ø© $tableId", textAlign: TextAlign.right),
        content: SizedBox(
          width: double.maxFinite,
          child: items.isEmpty
              ? const Text("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ù†Ø´Ø·Ø©", textAlign: TextAlign.center)
              : Column(
                  mainAxisSize: MainAxisSize.min,
                  children: [
                    Expanded(
                      child: ListView.builder(
                        shrinkWrap: true,
                        itemCount: items.length,
                        itemBuilder: (c, i) {
                          var item = items[i];
                          double p =
                              double.tryParse(
                                item['Price']?.toString() ?? "0",
                              ) ??
                              0.0;
                          int q =
                              int.tryParse(
                                item['Quantity']?.toString() ??
                                    item['quantity']?.toString() ??
                                    "0",
                              ) ??
                              0;
                          String itemNote = item['itemNote']?.toString() ?? "";

                          return Card(
                            margin: const EdgeInsets.symmetric(vertical: 4),
                            elevation: 0.5,
                            shape: RoundedRectangleBorder(
                              borderRadius: BorderRadius.circular(10),
                              side: BorderSide(color: Colors.grey.shade200),
                            ),
                            child: Padding(
                              padding: const EdgeInsets.all(8.0),
                              child: Column(
                                crossAxisAlignment: CrossAxisAlignment.end,
                                children: [
                                  Row(
                                    mainAxisAlignment:
                                        MainAxisAlignment.spaceBetween,
                                    children: [
                                      CircleAvatar(
                                        radius: 14,
                                        backgroundColor: const Color.fromARGB(
                                          255,
                                          252,
                                          252,
                                          0,
                                        ),
                                        child: Text(
                                          "$q",
                                          style: const TextStyle(
                                            fontSize: 12,
                                            fontWeight: FontWeight.bold,
                                          ),
                                        ),
                                      ),
                                      Text(
                                        item['productName'] ??
                                            item['ProductName'] ??
                                            "",
                                        style: const TextStyle(
                                          fontWeight: FontWeight.bold,
                                          fontSize: 15,
                                        ),
                                      ),
                                    ],
                                  ),
                                  Text(
                                    "Ø§Ù„Ø³Ø¹Ø±: ${p.toStringAsFixed(2)} JOD",
                                    style: TextStyle(
                                      color: Colors.grey.shade600,
                                      fontSize: 13,
                                    ),
                                  ),

                                  // âœ… ØªØ¹Ø¯ÙŠÙ„ Ø¹Ø±Ø¶ Ù…Ù„Ø§Ø­Ø¸Ø© Ø§Ù„ØµÙ†Ù Ù„ØªØ¸Ù‡Ø± Ø¨ÙˆØ¶ÙˆØ­ ØªØ­Øª Ø§Ù„ØµÙ†Ù
                                  if (itemNote.isNotEmpty && itemNote != "null")
                                    Container(
                                      margin: const EdgeInsets.only(top: 8),
                                      padding: const EdgeInsets.symmetric(
                                        horizontal: 8,
                                        vertical: 4,
                                      ),
                                      decoration: BoxDecoration(
                                        color: Colors.red.shade50,
                                        borderRadius: BorderRadius.circular(5),
                                      ),
                                      child: Row(
                                        mainAxisSize: MainAxisSize.min,
                                        children: [
                                          Expanded(
                                            child: Text(
                                              "Ù…Ù„Ø§Ø­Ø¸Ø©: $itemNote",
                                              textAlign: TextAlign.right,
                                              style: const TextStyle(
                                                color: Colors.redAccent,
                                                fontSize: 12,
                                                fontWeight: FontWeight.bold,
                                              ),
                                            ),
                                          ),
                                          const SizedBox(width: 5),
                                          const Icon(
                                            Icons.edit_note,
                                            size: 18,
                                            color: Colors.redAccent,
                                          ),
                                        ],
                                      ),
                                    ),
                                ],
                              ),
                            ),
                          );
                        },
                      ),
                    ),
                    const Divider(thickness: 2),

                    // Ù…Ù„Ø§Ø­Ø¸Ø© Ø§Ù„Ø·Ø§ÙˆÙ„Ø©
                    if (tableNote.isNotEmpty)
                      Container(
                        width: double.infinity,
                        padding: const EdgeInsets.all(8),
                        margin: const EdgeInsets.only(bottom: 10),
                        decoration: BoxDecoration(
                          color: Colors.amber[50],
                          borderRadius: BorderRadius.circular(8),
                          border: Border.all(color: Colors.amber.shade200),
                        ),
                        child: Text(
                          "ğŸ“ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ø·Ø§ÙˆÙ„Ø©: $tableNote",
                          textAlign: TextAlign.right,
                          style: const TextStyle(fontSize: 13),
                        ),
                      ),

                    _summaryRow(" : Ø¹Ø¯Ø¯ Ø§Ù„Ø§ØµÙ†Ø§Ù", "${items.length}"),
                    _summaryRow(" : Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒÙ…ÙŠØ©", "$totalQty"),
                    _summaryRow(
                      " : Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ",
                      "${totalAmount.toStringAsFixed(2)} JOD",
                      isBold: true,
                    ),
                  ],
                ),
        ),
        actions: [
          TextButton(
            onPressed: () => Navigator.pop(context),
            child: const Text("Ø¥ØºÙ„Ø§Ù‚"),
          ),
        ],
      ),
    );
  }

  Widget _summaryRow(String label, String value, {bool isBold = false}) {
    return Row(
      mainAxisAlignment: MainAxisAlignment.spaceBetween,
      children: [
        Text(
          value,
          style: TextStyle(
            fontWeight: isBold ? FontWeight.bold : FontWeight.normal,
          ),
        ),
        Text(
          label,
          style: TextStyle(
            fontWeight: isBold ? FontWeight.bold : FontWeight.normal,
          ),
        ),
      ],
    );
  }

  void _showOptions(TableModel table) {
    showModalBottomSheet(
      context: context,
      builder: (context) => SafeArea(
        child: Wrap(
          children: [
            ListTile(
              leading: const Icon(Icons.remove_red_eye),
              title: const Text('Ø¹Ø±Ø¶ Ø§Ù„Ø·Ù„Ø¨ Ø§Ù„Ø­Ø§Ù„ÙŠ'),
              onTap: () {
                Navigator.pop(context);
                _viewOrderDialog(table.id);
              },
            ),
            ListTile(
              leading: const Icon(Icons.add_circle_outline),
              title: const Text('Ø¥Ø¶Ø§ÙØ© Ø£ØµÙ†Ø§Ù Ø¬Ø¯ÙŠØ¯Ø©'),
              onTap: () {
                Navigator.pop(context);
                Navigator.push(
                  context,
                  MaterialPageRoute(
                    builder: (c) =>
                        MenuScreen(tableId: table.id, baseIp: baseIp),
                  ),
                ).then((_) => fetchTables());
              },
            ),
          ],
        ),
      ),
    );
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(
        title: const Text("Ù†Ø¸Ø§Ù… Ø§Ù„Ø·Ø§ÙˆÙ„Ø§Øª Ø§Ù„Ø°ÙƒÙŠ"),
        actions: [
          IconButton(icon: const Icon(Icons.refresh), onPressed: fetchTables),
        ],
      ),
      drawer: Drawer(
        child: Column(
          children: [
            DrawerHeader(
              decoration: BoxDecoration(color: Colors.blueGrey[50]),
              child: Column(
                mainAxisAlignment: MainAxisAlignment.center,
                children: [
                  Image.asset(
                    'assets/icon.png',
                    height: 60,
                    errorBuilder: (context, error, stackTrace) => const Icon(
                      Icons.business,
                      size: 50,
                      color: Colors.blueGrey,
                    ),
                  ),
                  const SizedBox(height: 10),
                  const Text(
                    "ØªÙƒÙ†ÙˆÙ„ÙˆØ¬ÙŠØ§ Ø§Ù„Ø¨Ø±Ù…Ø¬ÙŠØ§Øª Ø§Ù„Ø°ÙƒÙŠØ©",
                    style: TextStyle(
                      fontSize: 16,
                      fontWeight: FontWeight.bold,
                      color: Colors.blueGrey,
                    ),
                  ),
                  const Text(
                    "+962788315151",
                    style: TextStyle(fontSize: 12, color: Colors.grey),
                  ),
                ],
              ),
            ),
            Expanded(
              child: ListView(
                padding: EdgeInsets.zero,
                children: [
                  ListTile(
                    leading: const Icon(Icons.home, color: Colors.blueGrey),
                    title: const Text("Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©"),
                    onTap: () => Navigator.pop(context),
                  ),
                  ListTile(
                    leading: const Icon(
                      Icons.bar_chart,
                      color: Colors.blueGrey,
                    ),
                    title: const Text("ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª"),
                    onTap: () {
                      Navigator.pop(context);
                      ScaffoldMessenger.of(context).showSnackBar(
                        const SnackBar(
                          content: Text("Ø´Ø§Ø´Ø© Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø³ØªÙƒÙˆÙ† Ù…ØªØ§Ø­Ø© Ù‚Ø±ÙŠØ¨Ø§Ù‹"),
                        ),
                      );
                    },
                  ),
                  ListTile(
                    leading: const Icon(Icons.history, color: Colors.blueGrey),
                    title: const Text("Ø³Ø¬Ù„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª"),
                    onTap: () {
                      Navigator.pop(context);
                    },
                  ),
                  const Divider(),
                  ListTile(
                    leading: const Icon(Icons.settings, color: Colors.blueGrey),
                    title: const Text("Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø³ÙŠØ±ÙØ±"),
                    onTap: () async {
                      Navigator.pop(context);
                      bool? result = await Navigator.push(
                        context,
                        MaterialPageRoute(builder: (c) => SettingsScreen()),
                      );
                      if (result == true) _initIpAndFetch();
                    },
                  ),
                ],
              ),
            ),
            const Divider(),
            ListTile(
              leading: const Icon(Icons.logout, color: Colors.redAccent),
              title: const Text(
                "ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬",
                style: TextStyle(color: Colors.redAccent),
              ),
              onTap: () {
                showDialog(
                  context: context,
                  builder: (context) => AlertDialog(
                    title: const Text("ØªÙ†Ø¨ÙŠÙ‡", textAlign: TextAlign.right),
                    content: const Text(
                      "Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ù‚Ø§Ù‹ Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ØŸ",
                      textAlign: TextAlign.right,
                    ),
                    actions: [
                      TextButton(
                        onPressed: () => Navigator.pop(context),
                        child: const Text("Ø¥Ù„ØºØ§Ø¡"),
                      ),
                      TextButton(
                        onPressed: () {
                          SystemNavigator.pop();
                        },
                        child: const Text(
                          "Ø®Ø±ÙˆØ¬",
                          style: TextStyle(color: Colors.red),
                        ),
                      ),
                    ],
                  ),
                );
              },
            ),
            const SizedBox(height: 20),
          ],
        ),
      ),
      body: isLoading
          ? const Center(child: CircularProgressIndicator())
          : GridView.builder(
              padding: const EdgeInsets.all(8),
              gridDelegate: const SliverGridDelegateWithFixedCrossAxisCount(
                crossAxisCount: 4,
                crossAxisSpacing: 8,
                mainAxisSpacing: 8,
                childAspectRatio: 0.85,
              ),
              itemCount: tables.length,
              itemBuilder: (context, index) {
                final table = tables[index];
                bool isAvailable = table.status.toLowerCase() == "true";
                return InkWell(
                  onTap: () => isAvailable
                      ? Navigator.push(
                          context,
                          MaterialPageRoute(
                            builder: (c) =>
                                MenuScreen(tableId: table.id, baseIp: baseIp),
                          ),
                        ).then((_) => fetchTables())
                      : _showOptions(table),
                  child: Card(
                    color: isAvailable ? Colors.green[400] : Colors.red[400],
                    margin: EdgeInsets.zero,
                    child: Column(
                      mainAxisAlignment: MainAxisAlignment.center,
                      children: [
                        const Icon(
                          Icons.table_bar,
                          color: Colors.white,
                          size: 28,
                        ),
                        const SizedBox(height: 4),
                        Text(
                          "Ø·Ø§ÙˆÙ„Ø© ${table.id}",
                          style: const TextStyle(
                            color: Colors.white,
                            fontWeight: FontWeight.bold,
                            fontSize: 16,
                          ),
                        ),
                        Text(
                          isAvailable ? "Ù…ØªØ§Ø­Ø©" : "Ù…Ø´ØºÙˆÙ„Ø©",
                          style: const TextStyle(
                            color: Colors.white70,
                            fontSize: 12,
                          ),
                        ),
                      ],
                    ),
                  ),
                );
              },
            ),
    );
  }
}

// --- Ø§Ù„Ø´Ø§Ø´Ø© Ø§Ù„Ø«Ø§Ù†ÙŠØ©: Ø§Ù„Ù…Ù†ÙŠÙˆ (ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø´Ø±ÙŠØ· Ø§Ù„Ø¨Ø­Ø«) ---

class MenuScreen extends StatefulWidget {
  final int tableId;
  final String baseIp;
  MenuScreen({required this.tableId, required this.baseIp});
  @override
  _MenuScreenState createState() => _MenuScreenState();
}

class _MenuScreenState extends State<MenuScreen> {
  List<CategoryModel> categories = [];
  List<ProductModel> products = [];
  List<ProductModel> filteredProducts = [];
  List<Map<String, dynamic>> cart = [];
  String? selectedCategory;
  bool isLoading = true;

  final TextEditingController _searchController = TextEditingController();
  // âœ… Ù…ØªØ­ÙƒÙ… Ù…Ù„Ø§Ø­Ø¸Ø© Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ø¹Ø§Ù…Ø©
  final TextEditingController tableNoteController = TextEditingController();

  @override
  void initState() {
    super.initState();
    fetchCategories();
  }

  Future<void> fetchCategories() async {
    try {
      final res = await http.get(
        Uri.parse("http://${widget.baseIp}/api/categories/list"),
      );
      if (res.statusCode == 200) {
        List<dynamic> data = json.decode(res.body);
        setState(() {
          categories = data.map((i) => CategoryModel.fromJson(i)).toList();
          if (categories.isNotEmpty) {
            selectedCategory = categories[0].name;
            fetchProducts(selectedCategory!);
          }
        });
      }
    } catch (e) {
      debugPrint(e.toString());
    }
  }

  Future<void> fetchProducts(String catName) async {
    setState(() => isLoading = true);
    try {
      final res = await http.get(
        Uri.parse(
          "http://${widget.baseIp}/api/products/getbycategory?categoryName=$catName",
        ),
      );
      if (res.statusCode == 200) {
        List<dynamic> data = json.decode(res.body);
        setState(() {
          products = data.map((i) => ProductModel.fromJson(i)).toList();
          products.sort((a, b) => a.name.compareTo(b.name));
          filteredProducts = products;
          _searchController.clear();
          isLoading = false;
        });
      }
    } catch (e) {
      setState(() => isLoading = false);
    }
  }

  void _filterProducts(String query) {
    setState(() {
      filteredProducts = products
          .where((p) => p.name.toLowerCase().contains(query.toLowerCase()))
          .toList();
    });
  }

  void _showCartReview() {
    showModalBottomSheet(
      context: context,
      isScrollControlled: true,
      backgroundColor: Colors.transparent,
      builder: (context) => StatefulBuilder(
        // âœ… Ø¥Ø¶Ø§ÙØ© StatefulBuilder Ù‡Ù†Ø§
        builder: (BuildContext context, StateSetter setModalState) {
          // âœ… Ù†Ø­ØªØ§Ø¬ setModalState
          return Container(
            height: MediaQuery.of(context).size.height * 0.9,
            decoration: const BoxDecoration(
              color: Colors.white,
              borderRadius: BorderRadius.vertical(top: Radius.circular(25)),
            ),
            padding: EdgeInsets.only(
              left: 16,
              right: 16,
              top: 16,
              bottom: MediaQuery.of(context).viewInsets.bottom + 10,
            ),
            child: Column(
              children: [
                // Ø´Ø±ÙŠØ· Ø§Ù„Ø³Ø­Ø¨ Ø§Ù„Ø¹Ù„ÙˆÙŠ
                Container(
                  width: 50,
                  height: 5,
                  decoration: BoxDecoration(
                    color: Colors.grey[300],
                    borderRadius: BorderRadius.circular(10),
                  ),
                ),
                const SizedBox(height: 10),
                Row(
                  mainAxisAlignment: MainAxisAlignment.spaceBetween,
                  children: [
                    IconButton(
                      onPressed: () => Navigator.pop(context),
                      icon: const Icon(Icons.close),
                    ),
                    const Text(
                      "Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø·Ù„Ø¨",
                      style: TextStyle(
                        fontSize: 22,
                        fontWeight: FontWeight.bold,
                      ),
                    ),
                    const SizedBox(width: 40),
                  ],
                ),
                const Divider(),

                Expanded(
                  child: cart.isEmpty
                      ? const Center(child: Text("Ø§Ù„Ø·Ø§ÙˆÙ„Ø© ÙØ§Ø±ØºØ©"))
                      : ListView.builder(
                          itemCount: cart.length,
                          itemBuilder: (context, index) {
                            final item = cart[index];
                            return Card(
                              margin: const EdgeInsets.symmetric(vertical: 8),
                              shape: RoundedRectangleBorder(
                                borderRadius: BorderRadius.circular(15),
                              ),
                              child: Padding(
                                padding: const EdgeInsets.all(8.0),
                                child: Column(
                                  children: [
                                    ListTile(
                                      title: Text(
                                        item['name'],
                                        style: const TextStyle(
                                          fontWeight: FontWeight.bold,
                                        ),
                                      ),
                                      subtitle: Text("${item['price']} JOD"),
                                      trailing: Row(
                                        mainAxisSize: MainAxisSize.min,
                                        children: [
                                          IconButton(
                                            icon: const Icon(
                                              Icons.remove_circle_outline,
                                              color: Colors.red,
                                            ),
                                            onPressed: () {
                                              // âœ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø© Ø¯Ø§Ø®Ù„ Ø§Ù„Ù†Ø§ÙØ°Ø© ÙˆØ®Ø§Ø±Ø¬Ù‡Ø§
                                              setModalState(() {
                                                setState(() {
                                                  if (item['quantity'] > 1) {
                                                    item['quantity']--;
                                                  } else {
                                                    cart.removeAt(index);
                                                  }
                                                });
                                              });
                                            },
                                          ),
                                          Text(
                                            "${item['quantity']}",
                                            style: const TextStyle(
                                              fontSize: 16,
                                            ),
                                          ),
                                          IconButton(
                                            icon: const Icon(
                                              Icons.add_circle_outline,
                                              color: Colors.green,
                                            ),
                                            onPressed: () {
                                              // âœ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø© Ø¯Ø§Ø®Ù„ Ø§Ù„Ù†Ø§ÙØ°Ø© ÙˆØ®Ø§Ø±Ø¬Ù‡Ø§
                                              setModalState(() {
                                                setState(() {
                                                  item['quantity']++;
                                                });
                                              });
                                            },
                                          ),
                                        ],
                                      ),
                                    ),
                                    TextField(
                                      decoration: InputDecoration(
                                        hintText: "Ø£Ø¶Ù Ù…Ù„Ø§Ø­Ø¸Ø© Ù„Ù‡Ø°Ø§ Ø§Ù„ØµÙ†Ù...",
                                        prefixIcon: const Icon(Icons.edit_note),
                                        filled: true,
                                        fillColor: Colors.grey[100],
                                        border: OutlineInputBorder(
                                          borderRadius: BorderRadius.circular(
                                            10,
                                          ),
                                          borderSide: BorderSide.none,
                                        ),
                                      ),
                                      onChanged: (val) =>
                                          item['item_note'] = val,
                                    ),
                                  ],
                                ),
                              ),
                            );
                          },
                        ),
                ),

                TextField(
                  controller: tableNoteController,
                  decoration: const InputDecoration(
                    labelText: "Ù…Ù„Ø§Ø­Ø¸Ø© Ø¹Ø§Ù…Ø© Ù„Ù„Ø·Ø§ÙˆÙ„Ø©",
                    border: OutlineInputBorder(),
                    prefixIcon: Icon(Icons.table_restaurant),
                  ),
                ),
                const SizedBox(height: 10),

                Container(
                  padding: const EdgeInsets.all(15),
                  width: double.infinity,
                  child: ElevatedButton(
                    style: ElevatedButton.styleFrom(
                      backgroundColor: Colors.green,
                      padding: const EdgeInsets.symmetric(vertical: 15),
                      shape: RoundedRectangleBorder(
                        borderRadius: BorderRadius.circular(15),
                      ),
                    ),
                    onPressed: () {
                      Navigator.pop(context);
                      sendOrder();
                    },
                    child: const Text(
                      "ØªØ£ÙƒÙŠØ¯ ÙˆØ¥Ø±Ø³Ø§Ù„ Ù„Ù„Ù…Ø·Ø¨Ø®",
                      style: TextStyle(fontSize: 18, color: Colors.white),
                    ),
                  ),
                ),
              ],
            ),
          );
        },
      ),
    );
  }

  Future<void> sendOrder() async {
    if (cart.isEmpty) return;

    final List<Map<String, dynamic>> order = cart
        .map(
          (i) => {
            "TableID": widget.tableId,
            "ProductID": i['id'],
            "ProductName": i['name'],
            "Price": i['price'],
            "Quantity": i['quantity'],
            "ItemNote": i['item_note'] ?? "",
            "TableNote": tableNoteController.text,
          },
        )
        .toList();

    try {
      final res = await http.post(
        Uri.parse("http://${widget.baseIp}/api/orders/save"),
        headers: {"Content-Type": "application/json"},
        body: json.encode(order),
      );

      if (res.statusCode == 200) {
        tableNoteController.clear();
        setState(() => cart.clear());

        if (mounted) {
          // âœ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ù‡Ù†Ø§: Ø§Ù„Ø±Ø¬ÙˆØ¹ Ù„Ø´Ø§Ø´Ø© Ø§Ù„Ø·Ø§ÙˆÙ„Ø§Øª Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
          Navigator.of(context).popUntil((route) => route.isFirst);

          ScaffoldMessenger.of(context).showSnackBar(
            const SnackBar(content: Text("ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­ âœ…")),
          );
        }
      }
    } catch (e) {
      debugPrint("Error: $e");
    }
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(title: Text("Ù…Ù†ÙŠÙˆ Ø·Ø§ÙˆÙ„Ø© ${widget.tableId}")),
      body: Column(
        children: [
          Padding(
            padding: const EdgeInsets.symmetric(horizontal: 10, vertical: 8),
            child: TextField(
              controller: _searchController,
              onChanged: _filterProducts,
              textAlign: TextAlign.right,
              decoration: InputDecoration(
                hintText: "...Ø¨Ø­Ø« Ø¹Ù† ØµÙ†Ù",
                prefixIcon: const Icon(Icons.search),
                border: OutlineInputBorder(
                  borderRadius: BorderRadius.circular(10),
                ),
                contentPadding: const EdgeInsets.symmetric(vertical: 0),
              ),
            ),
          ),
          SizedBox(
            height: 60,
            child: ListView.builder(
              scrollDirection: Axis.horizontal,
              itemCount: categories.length,
              itemBuilder: (c, i) => Padding(
                padding: const EdgeInsets.symmetric(horizontal: 4),
                child: ChoiceChip(
                  label: Text(categories[i].name),
                  selected: selectedCategory == categories[i].name,
                  onSelected: (v) {
                    setState(() => selectedCategory = categories[i].name);
                    fetchProducts(categories[i].name);
                  },
                ),
              ),
            ),
          ),
          Expanded(
            child: isLoading
                ? const Center(child: CircularProgressIndicator())
                : GridView.builder(
                    padding: const EdgeInsets.all(8),
                    gridDelegate:
                        const SliverGridDelegateWithFixedCrossAxisCount(
                          crossAxisCount: 4,
                          childAspectRatio: 0.65,
                          crossAxisSpacing: 6,
                          mainAxisSpacing: 6,
                        ),
                    itemCount: filteredProducts.length,
                    itemBuilder: (c, i) {
                      final p = filteredProducts[i];
                      return Card(
                        elevation: 2,
                        child: Column(
                          mainAxisAlignment: MainAxisAlignment.spaceEvenly,
                          children: [
                            Text(
                              p.name,
                              textAlign: TextAlign.center,
                              style: const TextStyle(
                                fontWeight: FontWeight.bold,
                                fontSize: 11,
                              ),
                            ),
                            Text(
                              "${p.price} JOD",
                              style: const TextStyle(
                                color: Colors.blueGrey,
                                fontSize: 10,
                              ),
                            ),
                            SizedBox(
                              width: double.infinity,
                              height: 30,
                              child: ElevatedButton(
                                style: ElevatedButton.styleFrom(
                                  padding: EdgeInsets.zero,
                                ),
                                onPressed: () {
                                  setState(() {
                                    int idx = cart.indexWhere(
                                      (item) => item['name'] == p.name,
                                    );
                                    if (idx != -1) {
                                      cart[idx]['quantity']++;
                                    } else {
                                      cart.add({
                                        'id': p.id,
                                        'name': p.name,
                                        'price': p.price,
                                        'quantity': 1,
                                        'item_note': '', // âœ… ØªÙ‡ÙŠØ¦Ø© Ù…Ù„Ø§Ø­Ø¸Ø© Ø§Ù„ØµÙ†Ù
                                      });
                                    }
                                  });
                                },
                                child: const Icon(Icons.add, size: 18),
                              ),
                            ),
                          ],
                        ),
                      );
                    },
                  ),
          ),
        ],
      ),
      bottomNavigationBar: cart.isEmpty
          ? null
          : SafeArea(
              bottom: true,
              child: Container(
                height: 60,
                margin: const EdgeInsets.fromLTRB(10, 0, 10, 10),
                decoration: BoxDecoration(
                  color: Colors.black87,
                  borderRadius: BorderRadius.circular(15),
                  boxShadow: [
                    BoxShadow(
                      color: Colors.black.withOpacity(0.3),
                      blurRadius: 8,
                      offset: const Offset(0, -2),
                    ),
                  ],
                ),
                child: InkWell(
                  onTap: _showCartReview,
                  child: Row(
                    mainAxisAlignment: MainAxisAlignment.spaceAround,
                    children: [
                      Text(
                        "Ø§Ù„Ø£ØµÙ†Ø§Ù: ${cart.length}",
                        style: const TextStyle(
                          color: Colors.white,
                          fontSize: 16,
                        ),
                      ),
                      const Text(
                        "Ø¹Ø±Ø¶ Ø§Ù„Ø·Ù„Ø¨ âœ…",
                        style: TextStyle(
                          color: Colors.orange,
                          fontWeight: FontWeight.bold,
                          fontSize: 18,
                        ),
                      ),
                    ],
                  ),
                ),
              ),
            ),
    );
  }
}

// --- Ø´Ø§Ø´Ø© Ø§Ù„ØªØ±Ø­ÙŠØ¨ Ø§Ù„Ù…ØªØ­Ø±ÙƒØ© ---

class SplashScreen extends StatefulWidget {
  @override
  _SplashScreenState createState() => _SplashScreenState();
}

class _SplashScreenState extends State<SplashScreen>
    with SingleTickerProviderStateMixin {
  late AnimationController _controller;
  late Animation<double> _fadeAnimation;

  @override
  void initState() {
    super.initState();
    _controller = AnimationController(
      vsync: this,
      duration: const Duration(seconds: 2),
    );

    _fadeAnimation = Tween<double>(begin: 0.0, end: 1.0).animate(_controller);

    _controller.forward();

    Future.delayed(const Duration(seconds: 3), () {
      Navigator.pushReplacement(
        context,
        MaterialPageRoute(builder: (context) => TableManagementScreen()),
      );
    });
  }

  @override
  void dispose() {
    _controller.dispose();
    super.dispose();
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      backgroundColor: Colors.white,
      body: Center(
        child: FadeTransition(
          opacity: _fadeAnimation,
          child: Column(
            mainAxisAlignment: MainAxisAlignment.center,
            children: [
              Image.asset(
                'assets/icon.png',
                width: 150,
                errorBuilder: (context, error, stackTrace) => const Icon(
                  Icons.business,
                  size: 100,
                  color: Colors.blueGrey,
                ),
              ),
              const SizedBox(height: 20),
              const Text(
                "ØªÙƒÙ†ÙˆÙ„ÙˆØ¬ÙŠØ§ Ø§Ù„Ø¨Ø±Ù…Ø¬ÙŠØ§Øª Ø§Ù„Ø°ÙƒÙŠØ©",
                style: TextStyle(
                  fontSize: 24,
                  fontWeight: FontWeight.bold,
                  color: Colors.blueGrey,
                  letterSpacing: 1.2,
                ),
              ),
              const SizedBox(height: 10),
              const Text(
                "+962788315151 - info.sstecjo.com ",
                style: TextStyle(
                  fontSize: 16,
                  color: Colors.grey,
                  fontWeight: FontWeight.w500,
                ),
              ),
              const SizedBox(height: 10),
              const Text(
                "Ø¹Ù…Ø§Ù† - Ø´Ø§Ø±Ø¹ Ù…Ø§Ø¯Ø¨Ø§ - Ù…Ø¬Ù…Ø¹ Ø·ÙŠØ¨Ø© Ø§Ù„ØªØ¬Ø§Ø±ÙŠ",
                style: TextStyle(
                  fontSize: 16,
                  color: Colors.grey,
                  fontWeight: FontWeight.w500,
                ),
              ),
              const SizedBox(height: 50),
              const CircularProgressIndicator(
                valueColor: AlwaysStoppedAnimation<Color>(Colors.blueGrey),
              ),
            ],
          ),
        ),
      ),
    );
  }
}
