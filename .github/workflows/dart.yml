import 'package:flutter/material.dart';
import 'package:http/http.dart' as http;
import 'dart:convert';
import 'package:pdf/pdf.dart';
import 'package:pdf/widgets.dart' as pw;
import 'package:printing/printing.dart';
import 'package:shared_preferences/shared_preferences.dart';
import 'package:flutter/services.dart'; // Ù…ÙƒØªØ¨Ø© Ø§Ù„ØªØ­ÙƒÙ… ÙÙŠ Ø®Ø¯Ù…Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù…

void main() => runApp(
  MaterialApp(
    title: 'ØªÙƒÙ†ÙˆÙ„ÙˆØ¬ÙŠØ§ Ø§Ù„Ø¨Ø±Ù…Ø¬ÙŠØ§Øª Ø§Ù„Ø°ÙƒÙŠØ©',
    home: SplashScreen(), // Ø§Ù„Ø´Ø§Ø´Ø© Ø§Ù„Ù…ØªØ­Ø±ÙƒØ© Ù‡ÙŠ Ù†Ù‚Ø·Ø© Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø¢Ù†
    debugShowCheckedModeBanner: false,
    theme: ThemeData(primarySwatch: Colors.blueGrey, useMaterial3: true),
  ),
);

// --- Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„Ø§Øª (Data Models) ---

class TableModel {
  final int id;
  final String status;
  TableModel({required this.id, required this.status});
  factory TableModel.fromJson(Map<String, dynamic> json) =>
      TableModel(id: json['id'], status: json['status'].toString());
}

class CategoryModel {
  final String name;
  CategoryModel({required this.name});
  factory CategoryModel.fromJson(Map<String, dynamic> json) =>
      CategoryModel(name: json['name'] ?? json['CategoryName'] ?? "");
}

class ProductModel {
  final int id;
  final String name;
  final double price;
  ProductModel({required this.id, required this.name, required this.price});
  factory ProductModel.fromJson(Map<String, dynamic> json) => ProductModel(
    id: json['id'] ?? 0,
    name: json['name'] ?? "",
    price: (json['price'] ?? json['Price'] ?? 0.0).toDouble(),
  );
}

// --- Ø´Ø§Ø´Ø© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ---

class SettingsScreen extends StatefulWidget {
  @override
  _SettingsScreenState createState() => _SettingsScreenState();
}

class _SettingsScreenState extends State<SettingsScreen> {
  final TextEditingController _ipController = TextEditingController();

  @override
  void initState() {
    super.initState();
    _loadSavedIp();
  }

  _loadSavedIp() async {
    SharedPreferences prefs = await SharedPreferences.getInstance();
    setState(() {
      _ipController.text =
          prefs.getString('server_ip') ?? "192.168.100.41:35398";
    });
  }

  _saveIp() async {
    SharedPreferences prefs = await SharedPreferences.getInstance();
    await prefs.setString('server_ip', _ipController.text);
    ScaffoldMessenger.of(context).showSnackBar(
      const SnackBar(content: Text("ØªÙ… Ø­ÙØ¸ Ø¹Ù†ÙˆØ§Ù† IP Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ø¨Ù†Ø¬Ø§Ø­")),
    );
    Navigator.pop(context, true);
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(title: const Text("Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø³ÙŠØ±ÙØ±")),
      body: Padding(
        padding: const EdgeInsets.all(20.0),
        child: Column(
          children: [
            const Icon(Icons.settings_remote, size: 80, color: Colors.blueGrey),
            const SizedBox(height: 20),
            TextField(
              controller: _ipController,
              decoration: const InputDecoration(
                labelText: "Ø¹Ù†ÙˆØ§Ù† IP Ø§Ù„Ø³ÙŠØ±ÙØ± (Ù…Ø¹ Ø§Ù„Ø¨ÙˆØ±Øª)",
                hintText: "Ù…Ø«Ø§Ù„: 192.168.1.10:35398",
                border: OutlineInputBorder(),
              ),
              keyboardType: TextInputType.url,
            ),
            const SizedBox(height: 20),
            ElevatedButton.icon(
              onPressed: _saveIp,
              icon: const Icon(Icons.save),
              label: const Text("Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª"),
              style: ElevatedButton.styleFrom(
                minimumSize: const Size(double.infinity, 50),
              ),
            ),
          ],
        ),
      ),
    );
  }
}

// --- Ø§Ù„Ø´Ø§Ø´Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰: Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ø§ÙˆÙ„Ø§Øª ---

class TableManagementScreen extends StatefulWidget {
  @override
  _TableManagementScreenState createState() => _TableManagementScreenState();
}

class _TableManagementScreenState extends State<TableManagementScreen> {
  List<TableModel> tables = [];
  bool isLoading = true;
  String baseIp = "192.168.100.41:35398";

  @override
  void initState() {
    super.initState();
    _initIpAndFetch();
  }

  Future<void> _initIpAndFetch() async {
    SharedPreferences prefs = await SharedPreferences.getInstance();
    setState(() {
      baseIp = prefs.getString('server_ip') ?? "192.168.100.41:35398";
    });
    fetchTables();
  }

  Future<void> fetchTables() async {
    setState(() => isLoading = true);
    try {
      final response = await http.get(
        Uri.parse("http://$baseIp/api/tables/list"),
      );
      if (response.statusCode == 200) {
        List<dynamic> data = json.decode(response.body);
        setState(() {
          tables = data.map((item) => TableModel.fromJson(item)).toList();
          // ØªØ±ØªÙŠØ¨ Ø§Ù„Ø·Ø§ÙˆÙ„Ø§Øª Ù…Ù† 1 Ø¥Ù„Ù‰ ..
          tables.sort((a, b) => a.id.compareTo(b.id));
          isLoading = false;
        });
      }
    } catch (e) {
      setState(() => isLoading = false);
      debugPrint("Connection Error: $e");
    }
  }

  Future<List<dynamic>> getTableOrders(int tableId) async {
    try {
      final response = await http.get(
        Uri.parse("http://$baseIp/api/orders/kitchen"),
      );
      if (response.statusCode == 200) {
        List<dynamic> all = json.decode(response.body);
        return all
            .where((o) => (o['tableId'] == tableId || o['TableID'] == tableId))
            .toList();
      }
    } catch (e) {
      debugPrint(e.toString());
    }
    return [];
  }

  void _viewOrderDialog(int tableId) async {
    showDialog(
      context: context,
      builder: (c) => const Center(child: CircularProgressIndicator()),
    );
    var items = await getTableOrders(tableId);
    Navigator.pop(context);

    double totalAmount = 0.0;
    int totalQty = 0;

    for (var item in items) {
      double price =
          double.tryParse(item['Price'].toString()) ??
          double.tryParse(item['Price'].toString()) ??
          0.0;
      int qty =
          int.tryParse(item['quantity'].toString()) ??
          int.tryParse(item['Quantity'].toString()) ??
          0;
      totalAmount += (price * qty);
      totalQty += qty;
    }

    showDialog(
      context: context,
      builder: (context) => AlertDialog(
        title: Text("ØªÙØ§ØµÙŠÙ„ Ø·Ù„Ø¨ Ø·Ø§ÙˆÙ„Ø© $tableId", textAlign: TextAlign.right),
        content: SizedBox(
          width: double.maxFinite,
          child: items.isEmpty
              ? const Text("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ù†Ø´Ø·Ø©")
              : Column(
                  mainAxisSize: MainAxisSize.min,
                  children: [
                    Expanded(
                      child: ListView.builder(
                        shrinkWrap: true,
                        itemCount: items.length,
                        itemBuilder: (c, i) {
                          var item = items[i];
                          double p =
                              double.tryParse(item['Price'].toString()) ?? 0.0;
                          int q =
                              int.tryParse(item['quantity'].toString()) ?? 0;
                          return ListTile(
                            title: Text(
                              item['productName'] ?? "",
                              textAlign: TextAlign.right,
                            ),
                            subtitle: Text(
                              "JOD  ${p.toStringAsFixed(2)} : Ø§Ù„Ø³Ø¹Ø±",
                              textAlign: TextAlign.right,
                            ),
                            trailing: Text("Ø§Ù„ÙƒÙ…ÙŠØ© : $q"),
                          );
                        },
                      ),
                    ),
                    const Divider(thickness: 2),
                    _summaryRow(" : Ø¹Ø¯Ø¯ Ø§Ù„Ø£ØµÙ†Ø§Ù", "${items.length}"),
                    _summaryRow(" : Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒÙ…ÙŠØ©", "$totalQty"),
                    _summaryRow(
                      " : Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ",
                      "${totalAmount.toStringAsFixed(2)} JOD",
                      isBold: true,
                    ),
                  ],
                ),
        ),
        actions: [
          TextButton(
            onPressed: () => Navigator.pop(context),
            child: const Text("Ø¥ØºÙ„Ø§Ù‚"),
          ),
        ],
      ),
    );
  }

  Widget _summaryRow(String label, String value, {bool isBold = false}) {
    return Row(
      mainAxisAlignment: MainAxisAlignment.spaceBetween,
      children: [
        Text(
          value,
          style: TextStyle(
            fontWeight: isBold ? FontWeight.bold : FontWeight.normal,
          ),
        ),
        Text(
          label,
          style: TextStyle(
            fontWeight: isBold ? FontWeight.bold : FontWeight.normal,
          ),
        ),
      ],
    );
  }

  void _showOptions(TableModel table) {
    showModalBottomSheet(
      context: context,
      builder: (context) => SafeArea(
        child: Wrap(
          children: [
            ListTile(
              leading: const Icon(Icons.remove_red_eye),
              title: const Text('Ø¹Ø±Ø¶ Ø§Ù„Ø·Ù„Ø¨ Ø§Ù„Ø­Ø§Ù„ÙŠ'),
              onTap: () {
                Navigator.pop(context);
                _viewOrderDialog(table.id);
              },
            ),
            ListTile(
              leading: const Icon(Icons.add_circle_outline),
              title: const Text('Ø¥Ø¶Ø§ÙØ© Ø£ØµÙ†Ø§Ù Ø¬Ø¯ÙŠØ¯Ø©'),
              onTap: () {
                Navigator.pop(context);
                Navigator.push(
                  context,
                  MaterialPageRoute(
                    builder: (c) =>
                        MenuScreen(tableId: table.id, baseIp: baseIp),
                  ),
                ).then((_) => fetchTables());
              },
            ),
          ],
        ),
      ),
    );
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(
        title: const Text("Ù†Ø¸Ø§Ù… Ø§Ù„Ø·Ø§ÙˆÙ„Ø§Øª Ø§Ù„Ø°ÙƒÙŠ"),
        actions: [
          IconButton(icon: const Icon(Icons.refresh), onPressed: fetchTables),
        ],
      ),
      drawer: Drawer(
        child: Column(
          children: [
            DrawerHeader(
              decoration: BoxDecoration(color: Colors.blueGrey[50]),
              child: Column(
                mainAxisAlignment: MainAxisAlignment.center,
                children: [
                  Image.asset(
                    'assets/icon.png',
                    height: 60,
                    errorBuilder: (context, error, stackTrace) => const Icon(
                      Icons.business,
                      size: 50,
                      color: Colors.blueGrey,
                    ),
                  ),
                  const SizedBox(height: 10),
                  const Text(
                    "ØªÙƒÙ†ÙˆÙ„ÙˆØ¬ÙŠØ§ Ø§Ù„Ø¨Ø±Ù…Ø¬ÙŠØ§Øª Ø§Ù„Ø°ÙƒÙŠØ©",
                    style: TextStyle(
                      fontSize: 16,
                      fontWeight: FontWeight.bold,
                      color: Colors.blueGrey,
                    ),
                  ),
                  const Text(
                    "+962788315151",
                    style: TextStyle(fontSize: 12, color: Colors.grey),
                  ),
                ],
              ),
            ),
            Expanded(
              child: ListView(
                padding: EdgeInsets.zero,
                children: [
                  ListTile(
                    leading: const Icon(Icons.home, color: Colors.blueGrey),
                    title: const Text("Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©"),
                    onTap: () => Navigator.pop(context),
                  ),
                  ListTile(
                    leading: const Icon(
                      Icons.bar_chart,
                      color: Colors.blueGrey,
                    ),
                    title: const Text("ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª"),
                    onTap: () {
                      Navigator.pop(context);
                      ScaffoldMessenger.of(context).showSnackBar(
                        const SnackBar(
                          content: Text("Ø´Ø§Ø´Ø© Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø³ØªÙƒÙˆÙ† Ù…ØªØ§Ø­Ø© Ù‚Ø±ÙŠØ¨Ø§Ù‹"),
                        ),
                      );
                    },
                  ),
                  ListTile(
                    leading: const Icon(Icons.history, color: Colors.blueGrey),
                    title: const Text("Ø³Ø¬Ù„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª"),
                    onTap: () {
                      Navigator.pop(context);
                    },
                  ),
                  const Divider(),
                  ListTile(
                    leading: const Icon(Icons.settings, color: Colors.blueGrey),
                    title: const Text("Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø³ÙŠØ±ÙØ±"),
                    onTap: () async {
                      Navigator.pop(context);
                      bool? result = await Navigator.push(
                        context,
                        MaterialPageRoute(builder: (c) => SettingsScreen()),
                      );
                      if (result == true) _initIpAndFetch();
                    },
                  ),
                ],
              ),
            ),
            const Divider(),
            ListTile(
              leading: const Icon(Icons.logout, color: Colors.redAccent),
              title: const Text(
                "ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬",
                style: TextStyle(color: Colors.redAccent),
              ),
              onTap: () {
                showDialog(
                  context: context,
                  builder: (context) => AlertDialog(
                    title: const Text("ØªÙ†Ø¨ÙŠÙ‡", textAlign: TextAlign.right),
                    content: const Text(
                      "Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ù‚Ø§Ù‹ Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ØŸ",
                      textAlign: TextAlign.right,
                    ),
                    actions: [
                      TextButton(
                        onPressed: () => Navigator.pop(context),
                        child: const Text("Ø¥Ù„ØºØ§Ø¡"),
                      ),
                      TextButton(
                        onPressed: () {
                          SystemNavigator.pop();
                        },
                        child: const Text(
                          "Ø®Ø±ÙˆØ¬",
                          style: TextStyle(color: Colors.red),
                        ),
                      ),
                    ],
                  ),
                );
              },
            ),
            const SizedBox(height: 20),
          ],
        ),
      ),
      body: isLoading
          ? const Center(child: CircularProgressIndicator())
          : GridView.builder(
              padding: const EdgeInsets.all(8),
              gridDelegate: const SliverGridDelegateWithFixedCrossAxisCount(
                crossAxisCount: 4,
                crossAxisSpacing: 8,
                mainAxisSpacing: 8,
                childAspectRatio: 0.85,
              ),
              itemCount: tables.length,
              itemBuilder: (context, index) {
                final table = tables[index];
                bool isAvailable = table.status.toLowerCase() == "true";
                return InkWell(
                  onTap: () => isAvailable
                      ? Navigator.push(
                          context,
                          MaterialPageRoute(
                            builder: (c) =>
                                MenuScreen(tableId: table.id, baseIp: baseIp),
                          ),
                        ).then((_) => fetchTables())
                      : _showOptions(table),
                  child: Card(
                    color: isAvailable ? Colors.green[400] : Colors.red[400],
                    margin: EdgeInsets.zero,
                    child: Column(
                      mainAxisAlignment: MainAxisAlignment.center,
                      children: [
                        const Icon(
                          Icons.table_bar,
                          color: Colors.white,
                          size: 28,
                        ),
                        const SizedBox(height: 4),
                        Text(
                          "Ø·Ø§ÙˆÙ„Ø© ${table.id}",
                          style: const TextStyle(
                            color: Colors.white,
                            fontWeight: FontWeight.bold,
                            fontSize: 16,
                          ),
                        ),
                        Text(
                          isAvailable ? "Ù…ØªØ§Ø­Ø©" : "Ù…Ø´ØºÙˆÙ„Ø©",
                          style: const TextStyle(
                            color: Colors.white70,
                            fontSize: 12,
                          ),
                        ),
                      ],
                    ),
                  ),
                );
              },
            ),
    );
  }
}

// --- Ø§Ù„Ø´Ø§Ø´Ø© Ø§Ù„Ø«Ø§Ù†ÙŠØ©: Ø§Ù„Ù…Ù†ÙŠÙˆ (ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø´Ø±ÙŠØ· Ø§Ù„Ø¨Ø­Ø«) ---

class MenuScreen extends StatefulWidget {
  final int tableId;
  final String baseIp;
  MenuScreen({required this.tableId, required this.baseIp});
  @override
  _MenuScreenState createState() => _MenuScreenState();
}

class _MenuScreenState extends State<MenuScreen> {
  List<CategoryModel> categories = [];
  List<ProductModel> products = [];
  List<ProductModel> filteredProducts = []; // Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ØµÙØ§Ø© Ù„Ù„Ø¨Ø­Ø«
  List<Map<String, dynamic>> cart = [];
  String? selectedCategory;
  bool isLoading = true;

  // Ù…ØªØ­ÙƒÙ… Ù†Øµ Ø§Ù„Ø¨Ø­Ø«
  final TextEditingController _searchController = TextEditingController();

  @override
  void initState() {
    super.initState();
    fetchCategories();
  }

  Future<void> fetchCategories() async {
    try {
      final res = await http.get(
        Uri.parse("http://${widget.baseIp}/api/categories/list"),
      );
      if (res.statusCode == 200) {
        List<dynamic> data = json.decode(res.body);
        setState(() {
          categories = data.map((i) => CategoryModel.fromJson(i)).toList();
          if (categories.isNotEmpty) {
            selectedCategory = categories[0].name;
            fetchProducts(selectedCategory!);
          }
        });
      }
    } catch (e) {
      debugPrint(e.toString());
    }
  }

  Future<void> fetchProducts(String catName) async {
    setState(() => isLoading = true);
    try {
      final res = await http.get(
        Uri.parse(
          "http://${widget.baseIp}/api/products/getbycategory?categoryName=$catName",
        ),
      );
      if (res.statusCode == 200) {
        List<dynamic> data = json.decode(res.body);
        setState(() {
          products = data.map((i) => ProductModel.fromJson(i)).toList();
          products.sort((a, b) => a.name.compareTo(b.name));
          filteredProducts = products; // ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ØµÙØ§Ø© ÙÙŠ Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©
          _searchController.clear(); // Ù…Ø³Ø­ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ø§Ù„Ù‚Ø³Ù…
          isLoading = false;
        });
      }
    } catch (e) {
      setState(() => isLoading = false);
    }
  }

  // Ø¯Ø§Ù„Ø© ØªØµÙÙŠØ© Ø§Ù„Ø£ØµÙ†Ø§Ù Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø¨Ø­Ø«
  void _filterProducts(String query) {
    setState(() {
      filteredProducts = products
          .where((p) => p.name.toLowerCase().contains(query.toLowerCase()))
          .toList();
    });
  }

  void _showCartReview() {
    showModalBottomSheet(
      context: context,
      isScrollControlled: true,
      shape: const RoundedRectangleBorder(
        borderRadius: BorderRadius.vertical(top: Radius.circular(25)),
      ),
      builder: (context) => StatefulBuilder(
        builder: (context, setModalState) {
          double totalPrice = cart.fold(0, (sum, item) {
            double p = double.tryParse(item['price'].toString()) ?? 0.0;
            int q = int.tryParse(item['quantity'].toString()) ?? 0;
            return sum + (p * q);
          });

          return Container(
            // Ù‚Ù…Ù†Ø§ Ø¨ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„Ù€ padding Ø§Ù„Ø³ÙÙ„ÙŠ Ù‡Ù†Ø§ Ù„Ø£Ù† SafeArea Ø³ÙŠØªÙˆÙ„Ù‰ Ø§Ù„Ù…Ù‡Ù…Ø©
            padding: const EdgeInsets.fromLTRB(16, 16, 16, 10),
            height: MediaQuery.of(context).size.height * 0.6,
            child: Column(
              children: [
                Container(
                  width: 40,
                  height: 4,
                  margin: const EdgeInsets.only(bottom: 15),
                  decoration: BoxDecoration(
                    color: Colors.grey[300],
                    borderRadius: BorderRadius.circular(10),
                  ),
                ),
                const Text(
                  "ğŸ›’ Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø³Ù„Ø©",
                  style: TextStyle(fontSize: 20, fontWeight: FontWeight.bold),
                ),
                const Divider(),
                Expanded(
                  child: cart.isEmpty
                      ? const Center(child: Text("Ø§Ù„Ø³Ù„Ø© ÙØ§Ø±ØºØ©"))
                      : ListView.builder(
                          itemCount: cart.length,
                          itemBuilder: (context, index) {
                            final item = cart[index];
                            double itemPrice =
                                double.tryParse(item['price'].toString()) ??
                                0.0;
                            return Card(
                              margin: const EdgeInsets.symmetric(vertical: 5),
                              child: ListTile(
                                title: Text(item['name'] ?? ""),
                                subtitle: Text(
                                  "${itemPrice.toStringAsFixed(2)} JOD",
                                ),
                                trailing: Row(
                                  mainAxisSize: MainAxisSize.min,
                                  children: [
                                    IconButton(
                                      icon: const Icon(
                                        Icons.remove_circle,
                                        color: Colors.red,
                                      ),
                                      onPressed: () => setModalState(
                                        () => setState(() {
                                          if (item['quantity'] > 1)
                                            item['quantity']--;
                                          else
                                            cart.removeAt(index);
                                        }),
                                      ),
                                    ),
                                    Text(
                                      "${item['quantity']}",
                                      style: const TextStyle(
                                        fontWeight: FontWeight.bold,
                                      ),
                                    ),
                                    IconButton(
                                      icon: const Icon(
                                        Icons.add_circle,
                                        color: Colors.green,
                                      ),
                                      onPressed: () => setModalState(
                                        () =>
                                            setState(() => item['quantity']++),
                                      ),
                                    ),
                                  ],
                                ),
                              ),
                            );
                          },
                        ),
                ),
                const SizedBox(height: 10),

                // --- Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ù‡Ù†Ø§: Ø¥Ø¶Ø§ÙØ© SafeArea Ø­ÙˆÙ„ Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø²Ø± ---
                SafeArea(
                  child: Container(
                    padding: const EdgeInsets.all(12),
                    decoration: BoxDecoration(
                      color: Colors.grey[100],
                      borderRadius: BorderRadius.circular(15),
                    ),
                    child: Column(
                      mainAxisSize: MainAxisSize.min,
                      children: [
                        Row(
                          mainAxisAlignment: MainAxisAlignment.spaceBetween,
                          children: [
                            const Text(
                              "Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ:",
                              style: TextStyle(
                                fontSize: 18,
                                fontWeight: FontWeight.bold,
                              ),
                            ),
                            Text(
                              "${totalPrice.toStringAsFixed(2)} JOD",
                              style: const TextStyle(
                                fontSize: 18,
                                color: Colors.green,
                                fontWeight: FontWeight.bold,
                              ),
                            ),
                          ],
                        ),
                        const SizedBox(height: 15),
                        ElevatedButton(
                          style: ElevatedButton.styleFrom(
                            backgroundColor: Colors.green,
                            foregroundColor: Colors.white,
                            minimumSize: const Size(double.infinity, 55),
                            shape: RoundedRectangleBorder(
                              borderRadius: BorderRadius.circular(15),
                            ),
                            elevation: 0,
                          ),
                          onPressed: () {
                            Navigator.pop(context);
                            sendOrder();
                          },
                          child: const Text(
                            "Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ Ù„Ù„Ù…Ø·Ø¨Ø®",
                            style: TextStyle(
                              fontSize: 18,
                              fontWeight: FontWeight.bold,
                            ),
                          ),
                        ),
                      ],
                    ),
                  ),
                ),
              ],
            ),
          );
        },
      ),
    );
  }

  Future<void> sendOrder() async {
    final List<Map<String, dynamic>> order = cart
        .map(
          (i) => {
            "TableID": widget.tableId,
            "ProductName": i['name'],
            "Price": i['price'],
            "Quantity": i['quantity'],
          },
        )
        .toList();
    final res = await http.post(
      Uri.parse("http://${widget.baseIp}/api/orders/save"),
      headers: {"Content-Type": "application/json"},
      body: json.encode(order),
    );
    if (res.statusCode == 200) {
      Navigator.pop(context);
      ScaffoldMessenger.of(
        context,
      ).showSnackBar(const SnackBar(content: Text("ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨")));
    }
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(title: Text("Ù…Ù†ÙŠÙˆ Ø·Ø§ÙˆÙ„Ø© ${widget.tableId}")),
      body: Column(
        children: [
          // --- Ø¥Ø¶Ø§ÙØ© Ø´Ø±ÙŠØ· Ø§Ù„Ø¨Ø­Ø« ÙÙˆÙ‚ Ø§Ù„ØªØµÙ†ÙŠÙØ§Øª ---
          Padding(
            padding: const EdgeInsets.symmetric(horizontal: 10, vertical: 8),
            child: TextField(
              controller: _searchController,
              onChanged: _filterProducts,
              textAlign: TextAlign.right,
              decoration: InputDecoration(
                hintText: "...Ø¨Ø­Ø« Ø¹Ù† ØµÙ†Ù",
                prefixIcon: const Icon(Icons.search),
                border: OutlineInputBorder(
                  borderRadius: BorderRadius.circular(10),
                ),
                contentPadding: const EdgeInsets.symmetric(vertical: 0),
              ),
            ),
          ),
          SizedBox(
            height: 60,
            child: ListView.builder(
              scrollDirection: Axis.horizontal,
              itemCount: categories.length,
              itemBuilder: (c, i) => Padding(
                padding: const EdgeInsets.symmetric(horizontal: 4),
                child: ChoiceChip(
                  label: Text(categories[i].name),
                  selected: selectedCategory == categories[i].name,
                  onSelected: (v) {
                    setState(() => selectedCategory = categories[i].name);
                    fetchProducts(categories[i].name);
                  },
                ),
              ),
            ),
          ),
          Expanded(
            child: isLoading
                ? const Center(child: CircularProgressIndicator())
                : GridView.builder(
                    padding: const EdgeInsets.all(8),
                    gridDelegate:
                        const SliverGridDelegateWithFixedCrossAxisCount(
                          crossAxisCount: 4,
                          childAspectRatio: 0.65,
                          crossAxisSpacing: 6,
                          mainAxisSpacing: 6,
                        ),
                    itemCount:
                        filteredProducts.length, // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ØµÙØ§Ø©
                    itemBuilder: (c, i) {
                      final p = filteredProducts[i];
                      return Card(
                        elevation: 2,
                        child: Column(
                          mainAxisAlignment: MainAxisAlignment.spaceEvenly,
                          children: [
                            Text(
                              p.name,
                              textAlign: TextAlign.center,
                              maxLines: 2,
                              style: const TextStyle(
                                fontWeight: FontWeight.bold,
                                fontSize: 11,
                              ),
                            ),
                            Text(
                              "${p.price} JOD",
                              style: const TextStyle(
                                color: Colors.blueGrey,
                                fontSize: 10,
                              ),
                            ),
                            SizedBox(
                              width: double.infinity,
                              height: 30,
                              child: ElevatedButton(
                                style: ElevatedButton.styleFrom(
                                  padding: EdgeInsets.zero,
                                ),
                                onPressed: () {
                                  setState(() {
                                    int idx = cart.indexWhere(
                                      (item) => item['name'] == p.name,
                                    );
                                    if (idx != -1)
                                      cart[idx]['quantity']++;
                                    else
                                      cart.add({
                                        'name': p.name,
                                        'price': p.price,
                                        'quantity': 1,
                                      });
                                  });
                                },
                                child: const Icon(Icons.add, size: 18),
                              ),
                            ),
                          ],
                        ),
                      );
                    },
                  ),
          ),
        ],
      ),
      bottomNavigationBar: cart.isEmpty
          ? null
          : SafeArea(
              // ØªÙ… Ø¥Ø¶Ø§ÙØ© SafeArea Ù„Ø¶Ù…Ø§Ù† Ø§Ù„Ø¸Ù‡ÙˆØ± ÙÙˆÙ‚ Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù‡Ø§ØªÙ
              bottom: true,
              child: Container(
                height: 60,
                // Ø£Ø¶ÙØª margin Ø³ÙÙ„ÙŠ Ø¨Ø³ÙŠØ· Ù„ÙŠØ¹Ø·ÙŠ Ù…Ø¸Ù‡Ø±Ø§Ù‹ Ø¹Ø§Ø¦Ù…Ø§Ù‹ (Floating)
                margin: const EdgeInsets.fromLTRB(10, 0, 10, 10),
                decoration: BoxDecoration(
                  color: Colors.black87,
                  borderRadius: BorderRadius.circular(15),
                  // Ø¥Ø¶Ø§ÙØ© Ø¸Ù„ Ø¨Ø³ÙŠØ· Ù„ØªÙ…ÙŠÙŠØ² Ø§Ù„Ø´Ø±ÙŠØ· Ø¨Ø¹Ø¯ Ø±ÙØ¹Ù‡
                  boxShadow: [
                    BoxShadow(
                      color: Colors.black.withOpacity(0.3),
                      blurRadius: 8,
                      offset: const Offset(0, -2),
                    ),
                  ],
                ),
                child: InkWell(
                  onTap: _showCartReview,
                  child: Row(
                    mainAxisAlignment: MainAxisAlignment.spaceAround,
                    children: [
                      Text(
                        "Ø§Ù„Ø£ØµÙ†Ø§Ù: ${cart.length}",
                        style: const TextStyle(
                          color: Colors.white,
                          fontSize: 16,
                        ),
                      ),
                      const Text(
                        "Ø¹Ø±Ø¶ Ø§Ù„Ø³Ù„Ø© ğŸ›’",
                        style: TextStyle(
                          color: Colors.orange,
                          fontWeight: FontWeight.bold,
                          fontSize: 18,
                        ),
                      ),
                    ],
                  ),
                ),
              ),
            ),
    );
  }
}

// --- Ø´Ø§Ø´Ø© Ø§Ù„ØªØ±Ø­ÙŠØ¨ Ø§Ù„Ù…ØªØ­Ø±ÙƒØ© ---

class SplashScreen extends StatefulWidget {
  @override
  _SplashScreenState createState() => _SplashScreenState();
}

class _SplashScreenState extends State<SplashScreen>
    with SingleTickerProviderStateMixin {
  late AnimationController _controller;
  late Animation<double> _fadeAnimation;

  @override
  void initState() {
    super.initState();
    _controller = AnimationController(
      vsync: this,
      duration: const Duration(seconds: 2),
    );

    _fadeAnimation = Tween<double>(begin: 0.0, end: 1.0).animate(_controller);

    _controller.forward();

    Future.delayed(const Duration(seconds: 3), () {
      Navigator.pushReplacement(
        context,
        MaterialPageRoute(builder: (context) => TableManagementScreen()),
      );
    });
  }

  @override
  void dispose() {
    _controller.dispose();
    super.dispose();
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      backgroundColor: Colors.white,
      body: Center(
        child: FadeTransition(
          opacity: _fadeAnimation,
          child: Column(
            mainAxisAlignment: MainAxisAlignment.center,
            children: [
              Image.asset(
                'assets/icon.png',
                width: 150,
                errorBuilder: (context, error, stackTrace) => const Icon(
                  Icons.business,
                  size: 100,
                  color: Colors.blueGrey,
                ),
              ),
              const SizedBox(height: 20),
              const Text(
                "ØªÙƒÙ†ÙˆÙ„ÙˆØ¬ÙŠØ§ Ø§Ù„Ø¨Ø±Ù…Ø¬ÙŠØ§Øª Ø§Ù„Ø°ÙƒÙŠØ©",
                style: TextStyle(
                  fontSize: 24,
                  fontWeight: FontWeight.bold,
                  color: Colors.blueGrey,
                  letterSpacing: 1.2,
                ),
              ),
              const SizedBox(height: 10),
              const Text(
                "+962788315151 - info.sstecjo.com ",
                style: TextStyle(
                  fontSize: 16,
                  color: Colors.grey,
                  fontWeight: FontWeight.w500,
                ),
              ),
              const SizedBox(height: 10),
              const Text(
                "Ø¹Ù…Ø§Ù† - Ø´Ø§Ø±Ø¹ Ù…Ø§Ø¯Ø¨Ø§ - Ù…Ø¬Ù…Ø¹ Ø·ÙŠØ¨Ø© Ø§Ù„ØªØ¬Ø§Ø±ÙŠ",
                style: TextStyle(
                  fontSize: 16,
                  color: Colors.grey,
                  fontWeight: FontWeight.w500,
                ),
              ),
              const SizedBox(height: 50),
              const CircularProgressIndicator(
                valueColor: AlwaysStoppedAnimation<Color>(Colors.blueGrey),
              ),
            ],
          ),
        ),
      ),
    );
  }
}
